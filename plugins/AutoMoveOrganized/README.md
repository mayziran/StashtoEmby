# Auto Move Organized

一个强大的 Stash 插件，用于自动整理已整理（organized）的视频文件到指定目录，并生成元数据文件。

**注意**：此插件基于 [zyd16888/AutoMoveOrganized](https://github.com/zyd16888/AutoMoveOrganized) 修改而来。

## 功能特性

- **自动移动文件**：将已整理的文件移动到指定目录
- **智能命名**：支持灵活的文件和目录命名模板
- **元数据生成**：自动生成 NFO 文件和下载封面图片
- **AI 翻译**：支持标题和简介的 AI 翻译
- **双模式运行**：支持 Hook 模式（自动响应）和 Task 模式（手动批量处理）
- **智能更新**：对于已在目标目录的文件，可选择仅更新元数据或根据命名规则变化移动文件
- **附加工具**：包含用于上传演员信息到 Emby 和修复封面命名的实用脚本

## 安装

1. 将插件文件复制到 Stash 的插件目录
2. 在 Stash 设置中刷新插件列表
3. 配置插件参数

## 配置说明

### 基础设置

- **启用 Hook 模式**：启用后，当场景信息更新时自动执行文件整理
- **目标根目录**：移动到此目录下（如果设置了源目录映射，此项将被忽略）
- **源目录到目标目录的映射**：格式为 "源目录->目标目录"，例如 `/data/待整理->/data/已整理`
- **命名模板**：相对目标根目录的路径+文件名，支持多种占位符

### 命名模板占位符

可用占位符示例（不完全列表）：
- `{id}` - 场景 ID
- `{scene_title}` - 场景标题
- `{scene_date}` - 场景日期
- `{date_year}`, `{date_month}`, `{date_day}` - 年/月/日
- `{studio}` - 制作商名称
- `{performers}` - 演员列表
- `{first_performer}` - 第一个演员
- `{resolution}`, `{quality}` - 分辨率和质量
- `{original_basename}`, `{original_name}`, `{ext}` - 原始文件名相关

### 其他设置

- **只移动「已整理」文件**：是否只处理已整理的文件
- **仅模拟**：不真正执行操作，只显示将要做什么
- **生成 NFO 文件**：是否生成 NFO 元数据文件
- **下载封面图到视频目录**：是否下载封面图片
- **在封面右上角叠加厂商图标**：是否在封面叠加厂商 Logo
- **多文件模式**：如何处理包含多个文件的场景（all/primary_only/skip）

## 运行模式

### Hook 模式

启用 Hook 模式后，当场景信息更新时会自动执行文件整理。

**运行逻辑：**

1. **有映射时**：
   - 处理源目录中的文件（移动到目标目录）
   - 处理目标目录中的文件（更新元数据）

2. **无映射时**：
   - 处理不在目标目录的文件（移动到目标目录）
   - 处理目标目录中的文件（更新元数据）

3. **对于已在目标目录的文件**：
   - 总是重新生成 NFO 和封面
   - 若命名规则参数变化则移动到新路径

### Task 模式

通过 Stash 的 Tasks 页面手动执行，支持批量处理。

## Hook 模式详细运行逻辑

### 有映射时 (`source_target_mapping` 设置)

1. **检查文件是否在源目录**：
   - 如果在源目录 → 按 Task 模式逻辑处理（移动到目标目录）
   - 如果不在源目录 → 检查是否在目标目录：
     - 如果在目标目录 → 进行元数据更新
     - 如果不在目标目录 → 跳过处理

### 无映射时 (`source_target_mapping` 未设置)

1. **检查文件是否不在目标目录**：
   - 如果不在目标目录 → 按 Task 模式逻辑处理（移动到目标目录）
   - 如果已在目标目录 → 进行元数据更新

### 已在目标目录的文件处理

- **总是重新生成元数据**：删除旧的 NFO 和封面文件
- **判断是否需要移动**：
  - 如果场景信息变化影响了命名规则参数 → 移动到新路径并重新生成元数据
  - 如果场景信息变化不影响命名规则参数 → 保持在原路径但重新生成元数据

## 使用场景

### 初次整理
- 使用 Task 模式批量整理历史数据
- 设置源目录映射，将待整理文件移动到目标目录

### 日常维护
- 启用 Hook 模式，自动响应场景信息更新
- 当修改演员、标题、标签等信息时，自动更新 NFO 和封面

### 信息修正
- 当发现元数据错误并修正后，Hook 模式会自动更新相关文件
- 确保媒体服务器显示最新的元数据信息

## 注意事项

- 建议先启用 "仅模拟" 模式测试配置
- 使用源目录映射可以更好地控制文件流向
- Hook 模式会实时响应场景更新，请谨慎启用
- 多文件场景的处理方式可通过多文件模式设置控制

## 常见问题

### 1. 如何测试配置？
使用 "仅模拟" 选项，插件会显示将要执行的操作而不实际移动文件。

### 2. 如何只更新元数据而不移动文件？
对于已在目标目录的文件，插件会自动更新元数据。如果命名规则参数未变化，文件将保持在原位置。

### 3. 如何处理多文件场景？
通过 "多文件模式" 设置控制，可以选择处理所有文件、仅处理第一个文件或跳过多文件场景。

### 4. Hook 模式和 Task 模式的区别？
- Hook 模式：自动响应场景更新，适合日常维护
- Task 模式：手动批量处理，适合初次整理或定期维护

## 附加工具脚本

项目中还包含两个有用的工具脚本，由原作者提供：

### import.py
- **功能**：将演员图片和信息上传到 Emby 服务器
- **用途**：扫描当前目录及子目录下的 `actors` 文件夹，上传演员图片和元数据到 Emby
- **支持结构**：
  - `actors/演员名.jpg` (+ 可选同名 nfo)
  - `actors/演员名/actor.nfo + jpg` (推荐)
- **使用方法**：运行脚本并按提示输入 Emby 服务器地址和 API 密钥

### fix_posters_match_video.py
- **功能**：修复封面图片命名，使其与视频文件名匹配
- **用途**：修复带有 `-poster` 后缀但前缀与视频文件名不一致的封面图片
- **规则**：仅在目录中只有一个视频文件时进行修复，避免误操作
- **使用方法**：`python fix_posters_match_video.py /path/to/media/root`
- **安全性**：如果目标文件已存在，则跳过并输出提示

## 使用建议

### 工具脚本配合使用
1. **初次整理**：使用 `import.py` 将演员信息上传到 Emby
2. **文件整理**：使用主插件的 Task 模式批量整理文件
3. **封面修复**：使用 `fix_posters_match_video.py` 修复封面命名
4. **日常维护**：启用 Hook 模式自动响应场景更新