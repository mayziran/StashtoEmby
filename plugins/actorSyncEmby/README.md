# 演员同步 Emby 插件 (Actor Sync Emby)

一个 Stash 插件，用于将演员信息（图片和元数据）从 Stash 同步到 Emby 服务器。

## 功能特性

- **演员图片同步** - 从 Stash 下载演员头像并上传到 Emby
- **元数据导出** - 生成包含详细信息的 NFO 文件到本地目录
- **Emby 集成** - 通过 API 直接更新 Emby 中的演员元数据
- **多种同步模式** - 支持覆盖、只 NFO、只图片、增量补缺等模式
- **自动化钩子** - 支持在演员创建/更新时自动同步
- **批量处理** - 支持一次性同步所有演员
- **模拟运行** - 提供 dry-run 模式预览操作
- **可配置延迟** - 支持自定义新建演员异步同步的等待时间

## 安装

1. 将 `actorSyncEmby` 文件夹复制到 Stash 的插件目录
2. 重启 Stash 服务
3. 在 **设置 → 插件** 中启用该插件

## 配置选项

| 配置项 | 类型 | 默认值 | 描述 |
|--------|------|--------|------|
| `演员数据输出目录` | 字符串 | - | 本地存储演员图片和 NFO 文件的目录路径 |
| `Task：本地导出模式` | 数字 | 0 | 0=不导出，1=覆盖 (图片+NFO)，2=只 NFO，3=只图片，4=补缺 |
| `Task：Emby 上传模式` | 数字 | 0 | 0=不上传，1=覆盖 (图片 + 元数据)，2=只元数据，3=只图片，4=补缺 |
| `Hook 响应模式` | 数字 | 0 | 0=关闭，1=只本地 (覆盖)，2=只 Emby(覆盖)，3=同时 (覆盖) |
| `Emby 服务器地址` | 字符串 | - | Emby 服务器完整 URL（如 `http://192.168.1.100:8096`） |
| `Emby API 密钥` | 字符串 | - | Emby 服务器 API 密钥 |
| `仅模拟` | 布尔值 | false | 模拟运行模式，不执行实际文件操作 |
| `启用异步日志` | 布尔值 | true | 是否将新建演员异步同步日志写入文件 |
| `新建演员异步同步延迟时间` | 字符串 | "35,70" | 格式：`等待 Stash 更新演员影片时间，等待 Emby 刷新时间`（秒） |

## 同步模式说明

### Task：本地导出模式

| 模式 | 名称 | 说明 |
|------|------|------|
| 0 | 不导出 | 跳过本地文件导出 |
| 1 | 覆盖 (图片+NFO) | 无论本地是否已存在，都会重新生成 NFO 和下载图片 |
| 2 | 只 NFO | 仅生成 NFO 元数据文件，不处理演员图片 |
| 3 | 只图片 | 仅下载演员图片，不生成 NFO 文件 |
| 4 | 增量补缺 | 检查本地已有的文件，只导出缺失的部分 |

**模式 1 适用场景**：需要完全同步，确保本地数据与 Stash 一致

**模式 4 适用场景**：批量处理时避免重复导出，提高 IO 效率

---

### Task：Emby 上传模式

| 模式 | 名称 | 说明 |
|------|------|------|
| 0 | 不上传 | 跳过 Emby 上传 |
| 1 | 覆盖 (图片 + 元数据) | 无论 Emby 中是否已存在，都会重新上传图片和更新元数据 |
| 2 | 只元数据 | 仅更新演员文本信息（概述、生日、标签等），不处理演员图片 |
| 3 | 只图片 | 仅上传演员头像，不更新元数据 |
| 4 | 增量补缺 | 检查 Emby 中已有的数据，只上传缺失的部分（只处理已存在的演员） |

**模式 1 适用场景**：需要完全同步，确保 Emby 数据与 Stash 一致

**模式 4 适用场景**：批量处理时避免重复上传，减少 API 调用

---

### Hook 响应模式

| 模式 | 名称 | 说明 |
|------|------|------|
| 0 | 关闭 | 不响应 Hook 事件 |
| 1 | 只出本地 | 演员更新时只导出到本地目录（覆盖模式：图片+NFO） |
| 2 | 只上传 Emby | 演员更新时只上传到 Emby（覆盖模式：图片 + 元数据） |
| 3 | 同时输出 | 演员更新时同时导出本地和上传 Emby |

**Hook 触发时机**：
- `Performer.Create.Post` - 演员创建后（异步延迟执行）
- `Performer.Update.Post` - 演员更新后（同步执行）

**新建演员异步延迟说明**：
- 阶段 1：等待 Stash 更新演员影片信息（默认 35 秒）
- 阶段 2：刷新 Emby 演员库
- 阶段 3：等待 Emby 刷新完成（默认 70 秒）
- 阶段 4：上传演员信息到 Emby

通过 `新建演员异步同步延迟时间` 配置项可调整等待时间，例如 `"50,90"` 表示等待 Stash 更新 50 秒，等待 Emby 刷新 90 秒。

## 使用方法

### 自动同步（推荐）

1. 在插件配置中设置 `Hook 响应模式 = 3`（同时输出）
2. 在演员信息更新时，自动同步到本地和 Emby

### 手动批量同步

1. 在插件配置中设置 `Task：本地导出模式` 和 `Task：Emby 上传模式`
2. 在 **Tasks** 页面运行 **"同步所有演员"** 任务
3. 等待任务完成，查看日志了解处理进度

## 数据结构

### 本地导出的文件结构

```
演员数据输出目录/
├── 演员姓名/
│   ├── folder.jpg (演员头像)
│   └── actor.nfo (演员详细信息)
```

### NFO 文件包含的信息

- **基本信息**：姓名、性别、国家、出生/死亡日期
- **身体特征**：身高、体重、三围、假胸、种族等
- **外貌描述**：发色、眼色、纹身、穿孔等
- **其他信息**：职业生涯、别名、个人网站链接
- **外部标识符**：Stash ID

## Emby 元数据更新

插件通过 Emby API 直接更新以下元数据：

- **概述**：包含所有演员信息的详细描述
- **生日和死亡日期**：PremiereDate / EndDate
- **制作地点**：国家
- **标签**：性别、国家、种族、身体特征等
- **外部 ID**：Stash ID（ProviderIds.Stash）

## 配置示例

### 示例 1：完全同步（推荐）

```yaml
演员数据输出目录：/data/actors
Task：本地导出模式：1
Task：Emby 上传模式：1
Hook 响应模式：3
Emby 服务器地址：http://192.168.1.100:8096
Emby API 密钥：your-api-key
```

### 示例 2：增量补缺模式

```yaml
演员数据输出目录：/data/actors
Task：本地导出模式：4
Task：Emby 上传模式：4
Hook 响应模式：3
```

### 示例 3：慢速环境（调整延迟时间）

```yaml
新建演员异步同步延迟时间：60,120
```

## 故障排除

### 无法连接到 Emby 服务器
- 检查服务器地址和 API 密钥是否正确
- 确认网络连接正常
- 验证 Emby 服务器正在运行

### 图片未上传到 Emby
- 确认 Emby 上传模式已启用（不为 0）
- 检查 Stash 中演员是否有图片
- 验证 Emby API 密钥权限
- 确认演员名称在 Emby 中存在

### 元数据未更新
- 确认 Emby 上传模式包含元数据（模式 1 或 2）
- 检查 Emby 中是否存在同名演员
- 查看 Stash 日志获取详细错误信息

### 新建演员上传失败
- 检查 `启用异步日志` 是否开启
- 查看 `actor_sync_worker.log` 文件了解详细错误
- 确认延迟时间是否足够（慢速环境可增加延迟时间）

## 依赖

- Python 3.8+
- stashapi
- requests

## 版本历史

### 1.0.9
- ✅ 新增 `workerDelays` 配置项，支持自定义异步同步延迟时间
- ✅ 修复补缺模式下会为不存在的演员尝试上传的问题
- ✅ 优化日志输出，更清晰地说明等待阶段

### 1.0.8
- 多种同步模式支持（覆盖、只 NFO、只图片、补缺）
- Hook 响应模式优化
- 批量处理性能优化

### 1.0.0
- 初始版本

## 许可证

MIT License
